---
# Geoloc OS - Role-based system provisioning
# Main playbook that orchestrates all roles for system setup

- name: Setup Geoloc OS with role-based structure
  hosts: localhost
  become: false
  connection: local
  gather_facts: true

  pre_tasks:
    - name: Display setup information
      debug:
        msg: "Starting Geoloc OS setup: Base + Desktop + Development + Extras"

    # Hardware auto-detection (only when not explicitly set in user.yml)
    - name: Auto-detect CPU vendor
      set_fact:
        cpu_ucode: >-
          {{ 'amd-ucode' if ansible_facts.processor | select('match', '.*AMD.*') | list | length > 0
             else 'intel-ucode' }}
      when: cpu_ucode is not defined

    - name: Detect GPU vendor via lspci
      shell: lspci | grep -i 'vga\|3d\|display'
      register: gpu_lspci
      changed_when: false
      failed_when: false
      when: gpu_packages is not defined

    - name: Auto-detect GPU packages
      set_fact:
        gpu_packages: >-
          {{ ['nvidia', 'nvidia-utils', 'lib32-nvidia-utils']
             if 'NVIDIA' in gpu_lspci.stdout
             else (['mesa', 'vulkan-intel', 'lib32-mesa', 'lib32-vulkan-intel']
                   if 'Intel' in gpu_lspci.stdout
                   else ['mesa', 'vulkan-radeon', 'lib32-mesa', 'lib32-vulkan-radeon']) }}
      when:
        - gpu_packages is not defined
        - gpu_lspci.stdout is defined

    - name: Display detected hardware
      debug:
        msg: |
          Hardware configuration:
            CPU microcode: {{ cpu_ucode | default('not set') }}
            GPU packages:  {{ gpu_packages | default([]) | join(', ') }}
            Timezone:      {{ timezone | default('Europe/Copenhagen') }}

  roles:
    - { role: base, tags: ["base"] }
    - { role: desktop, tags: ["desktop"] }
    - { role: development, tags: ["development"] }
    - { role: extras, tags: ["extras"] }
    - { role: system-hardening, tags: ["system-hardening"] }
    - { role: dotfiles, tags: ["dotfiles"] }

  post_tasks:
    - name: Display completion message
      debug:
        msg: |
          Geoloc OS setup complete!

          Next steps:
          1. Reboot to ensure all services are running
          2. Log out and back in for shell changes to take effect
