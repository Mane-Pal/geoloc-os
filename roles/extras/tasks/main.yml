---
# Extras role - Optional and work-related applications
# Combines optional apps and work-related tools like ClamAV

- name: Install extra packages
  become: true
  pacman:
    name: "{{ packages.extras }}"
    state: present

- name: Install extras AUR packages
  kewlfft.aur.aur:
    name: "{{ item }}"
    use: paru
    state: present
    extra_args: --noconfirm --needed
  become: yes
  become_user: aur_builder
  vars:
    ansible_python_interpreter: /usr/bin/python3
  loop: "{{ aur_packages.extras }}"
  register: aur_extras_results
  when: aur_packages.extras | length > 0

- name: Report failed extras AUR packages
  fail:
    msg: |
      The following extras AUR packages failed to install:
      {% for result in aur_extras_results.results | selectattr('failed', 'defined') | selectattr('failed') %}
      - {{ result.item }}: {{ result.msg | default('unknown error') }}
      {% endfor %}
  when:
    - aur_extras_results.results is defined
    - aur_extras_results.results | selectattr('failed', 'defined') | selectattr('failed') | list | length > 0

# ClamAV Configuration
- name: Create ClamAV log directory
  become: true
  file:
    path: /var/log/clamav
    state: directory
    owner: clamav
    group: clamav
    mode: '0755'

- name: Configure ClamAV freshclam
  become: true
  copy:
    src: freshclam.conf
    dest: /etc/clamav/freshclam.conf
    mode: '0644'
    backup: yes

- name: Configure ClamAV daemon
  become: true
  copy:
    src: clamd.conf
    dest: /etc/clamav/clamd.conf
    mode: '0644'
    backup: yes

- name: Install ClamAV virus event handler
  become: true
  copy:
    src: virus-event.sh
    dest: /etc/clamav/virus-event.sh
    mode: '0755'

- name: Stop freshclam service before manual database update
  become: true
  systemd:
    name: clamav-freshclam.service
    state: stopped
  failed_when: false

- name: Update ClamAV virus database
  become: true
  command: freshclam
  register: freshclam_result
  failed_when:
    - freshclam_result.rc != 0
    - "'database is up to date' not in freshclam_result.stderr"
    - "'locked by another process' not in freshclam_result.stderr"
    - "'Failed to lock' not in freshclam_result.stdout"
  changed_when: "'Database updated' in freshclam_result.stdout"

- name: Enable and start ClamAV services
  become: true
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
    daemon_reload: yes
  loop:
    - clamav-freshclam.service
    - clamav-daemon.service

- name: Verify ClamAV installation
  debug:
    msg: |
      ClamAV services should now be running.
      Check status with: systemctl status clamav-daemon clamav-freshclam
      Test detection with: clamscan --version
