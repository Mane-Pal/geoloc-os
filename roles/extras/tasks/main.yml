---
# Extras role - Optional and work-related applications
# Combines optional apps and work-related tools like ClamAV

- name: Install extra packages
  become: true
  pacman:
    name: "{{ packages.extras }}"
    state: present

# ClamAV Configuration
- name: Create ClamAV log directory
  become: true
  file:
    path: /var/log/clamav
    state: directory
    owner: clamav
    group: clamav
    mode: '0755'

- name: Configure ClamAV freshclam
  become: true
  copy:
    src: freshclam.conf
    dest: /etc/clamav/freshclam.conf
    mode: '0644'
    backup: yes

- name: Configure ClamAV daemon
  become: true
  copy:
    src: clamd.conf
    dest: /etc/clamav/clamd.conf
    mode: '0644'
    backup: yes

- name: Install ClamAV virus event handler
  become: true
  copy:
    src: virus-event.sh
    dest: /etc/clamav/virus-event.sh
    mode: '0755'

- name: Update ClamAV virus database
  become: true
  command: freshclam
  register: freshclam_result
  failed_when:
    - freshclam_result.rc != 0
    - "'database is up to date' not in freshclam_result.stderr"
    - "'locked by another process' not in freshclam_result.stderr"
  changed_when: "'Database updated' in freshclam_result.stdout"

- name: Enable and start ClamAV services
  become: true
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
    daemon_reload: yes
  loop:
    - clamav-freshclam.service
    - clamav-daemon.service

- name: Verify ClamAV installation
  debug:
    msg: |
      ClamAV services should now be running.
      Check status with: systemctl status clamav-daemon clamav-freshclam
      Test detection with: clamscan --version
