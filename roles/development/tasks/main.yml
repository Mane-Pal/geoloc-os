---
# Development role - Professional development tools
# This role installs development tools, containers, and programming languages

- name: Install development packages
  become: true
  pacman:
    name: "{{ packages.dev }}"
    state: present

- name: Install development AUR packages
  kewlfft.aur.aur:
    name: "{{ item }}"
    use: paru
    state: present
    extra_args: --noconfirm --needed
  become: yes
  become_user: aur_builder
  vars:
    ansible_python_interpreter: /usr/bin/python3
  loop: "{{ aur_packages.dev }}"
  register: aur_dev_results
  when: aur_packages.dev | length > 0

- name: Report failed development AUR packages
  fail:
    msg: |
      The following development AUR packages failed to install:
      {% for result in aur_dev_results.results | selectattr('failed', 'defined') | selectattr('failed') %}
      - {{ result.item }}: {{ result.msg | default('unknown error') }}
      {% endfor %}
  when:
    - aur_dev_results.results is defined
    - aur_dev_results.results | selectattr('failed', 'defined') | selectattr('failed') | list | length > 0

# --- Rootless Docker Setup ---
# Runs the Docker daemon as the current user instead of root.
# Files created in bind mounts are owned by the host user, not root.

- name: Configure subordinate UID ranges for rootless Docker
  become: true
  lineinfile:
    path: /etc/subuid
    regexp: "^{{ ansible_facts.env.USER }}:"
    line: "{{ ansible_facts.env.USER }}:100000:65536"
    create: yes
    mode: '0644'
  when: "'docker' in packages.dev"

- name: Configure subordinate GID ranges for rootless Docker
  become: true
  lineinfile:
    path: /etc/subgid
    regexp: "^{{ ansible_facts.env.USER }}:"
    line: "{{ ansible_facts.env.USER }}:100000:65536"
    create: yes
    mode: '0644'
  when: "'docker' in packages.dev"

- name: Enable user lingering for rootless Docker at boot
  become: true
  command: loginctl enable-linger {{ ansible_facts.env.USER }}
  changed_when: false
  when: "'docker' in packages.dev"

- name: Disable system Docker service (using rootless instead)
  become: true
  systemd:
    name: docker
    enabled: no
    state: stopped
  failed_when: false
  when: "'docker' in packages.dev"

- name: Disable system Docker socket
  become: true
  systemd:
    name: docker.socket
    enabled: no
    state: stopped
  failed_when: false
  when: "'docker' in packages.dev"

- name: Create user Docker config directory
  file:
    path: "{{ ansible_facts.env.HOME }}/.config/docker"
    state: directory
    mode: '0755'
  when: "'docker' in packages.dev"

- name: Configure rootless Docker daemon
  copy:
    src: docker-rootless-daemon.json
    dest: "{{ ansible_facts.env.HOME }}/.config/docker/daemon.json"
    mode: '0644'
    backup: yes
  when: "'docker' in packages.dev"
  notify: restart rootless docker

- name: Ensure iptables kernel modules load at boot (required by rootless Docker)
  become: true
  copy:
    content: |
      ip_tables
      ip6_tables
    dest: /etc/modules-load.d/docker-rootless.conf
    mode: '0644'
  when: "'docker' in packages.dev"

- name: Load iptables kernel modules now
  become: true
  modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - ip_tables
    - ip6_tables
  when: "'docker' in packages.dev"

- name: Enable rootless Docker user service
  systemd:
    name: docker
    enabled: yes
    state: started
    scope: user
  when: "'docker' in packages.dev"

# --- systemd-resolved (general DNS resolution) ---

- name: Enable systemd-resolved
  become: true
  systemd:
    name: systemd-resolved
    enabled: yes
    state: started
