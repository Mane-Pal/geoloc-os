---
# Dotfiles role - Clone and deploy personal dotfiles using GNU Stow

- name: Ensure stow is installed
  become: true
  pacman:
    name: stow
    state: present

- name: Check if dotfiles already cloned
  stat:
    path: "{{ dotfiles_dest }}"
  register: dotfiles_dir

- name: Clone dotfiles repository
  git:
    repo: "{{ dotfiles_repo }}"
    dest: "{{ dotfiles_dest }}"
    version: "{{ dotfiles_branch | default('master') }}"
    accept_hostkey: yes
  when: not dotfiles_dir.stat.exists

- name: Check for local modifications in dotfiles
  command: git status --porcelain
  args:
    chdir: "{{ dotfiles_dest }}"
  register: dotfiles_local_changes
  changed_when: false
  when: dotfiles_dir.stat.exists

- name: Update dotfiles repository
  git:
    repo: "{{ dotfiles_repo }}"
    dest: "{{ dotfiles_dest }}"
    version: "{{ dotfiles_branch | default('master') }}"
    update: yes
  when:
    - dotfiles_dir.stat.exists
    - dotfiles_local_changes.stdout == ""

- name: Warn about local dotfiles modifications
  debug:
    msg: "Skipping dotfiles update â€” local modifications detected. Commit or stash changes to enable updates."
  when:
    - dotfiles_dir.stat.exists
    - dotfiles_local_changes.stdout != ""

- name: Check if stow backup already exists
  stat:
    path: "{{ ansible_facts.env.HOME }}/.config.pre-stow.tar.gz"
  register: stow_backup

- name: Backup .config before first stow deployment
  archive:
    path: "{{ ansible_facts.env.HOME }}/.config"
    dest: "{{ ansible_facts.env.HOME }}/.config.pre-stow.tar.gz"
    format: gz
  when: not stow_backup.stat.exists
  failed_when: false

- name: Stow dotfiles packages
  command: stow -v --adopt -R {{ item }}
  args:
    chdir: "{{ dotfiles_dest }}"
  loop: "{{ dotfiles_packages }}"
  register: stow_result
  changed_when: stow_result.stdout != ''
  failed_when: stow_result.rc != 0
