---
# Desktop role - Desktop environment and system services
# Combines desktop and services functionality

- name: Install desktop packages
  become: true
  pacman:
    name: "{{ packages.desktop + (gpu_packages if gpu_packages is defined else []) }}"
    state: present

- name: Install pipewire-jack (replaces jack2)
  become: true
  shell: yes | pacman -S pipewire-jack --noconfirm
  args:
    creates: /usr/lib/pipewire-0.3/jack/libjack.so
  register: pipewire_jack_result
  failed_when:
    - pipewire_jack_result.rc != 0
    - "'is up to date' not in pipewire_jack_result.stdout"
    - "'there is nothing to do' not in pipewire_jack_result.stdout"

- name: Enable NetworkManager
  become: true
  systemd:
    name: NetworkManager
    enabled: yes
    state: started

- name: Enable Bluetooth service
  become: true
  systemd:
    name: bluetooth
    enabled: yes
    state: started

- name: Enable SDDM display manager
  become: true
  systemd:
    name: sddm
    enabled: yes

- name: Mask power-profiles-daemon to prevent conflicts with TLP
  become: true
  systemd:
    name: power-profiles-daemon
    enabled: no
    masked: yes

- name: Enable TLP power management
  become: true
  systemd:
    name: tlp
    enabled: yes
    state: started

- name: Enable Avahi daemon
  become: true
  systemd:
    name: avahi-daemon
    enabled: yes
    state: started

- name: Create systemd user directory
  file:
    path: "{{ ansible_facts.env.HOME }}/.config/systemd/user"
    state: directory
    mode: "0755"

- name: Create SDDM config directory
  become: true
  file:
    path: /etc/sddm.conf.d
    state: directory
    mode: "0755"

- name: Create NetworkManager conf.d directory
  become: true
  file:
    path: /etc/NetworkManager/conf.d
    state: directory
    mode: "0755"

- name: Configure SDDM display manager
  become: true
  template:
    src: sddm.conf.j2
    dest: /etc/sddm.conf.d/sddm.conf
    mode: "0644"
    backup: yes

- name: Check for Intel WiFi hardware
  shell: lspci | grep -qi "intel.*wireless\|intel.*wi-fi\|intel.*wifi"
  register: intel_wifi_check
  failed_when: false
  changed_when: false

- name: Configure iwlwifi driver optimizations for Intel WiFi stability
  become: true
  copy:
    src: iwlwifi.conf
    dest: /etc/modprobe.d/iwlwifi.conf
    mode: "0644"
    backup: yes
  notify: rebuild initramfs
  when: intel_wifi_check.rc == 0

- name: Configure NetworkManager WiFi stability settings
  become: true
  copy:
    src: networkmanager-wifi.conf
    dest: /etc/NetworkManager/conf.d/wifi-stability.conf
    mode: "0644"
    backup: yes
  notify: restart NetworkManager

- name: Add udev rule to disable WiFi power saving
  become: true
  copy:
    src: 70-wifi-powersave.rules
    dest: /etc/udev/rules.d/70-wifi-powersave.rules
    mode: "0644"
    backup: yes
  notify: reload udev rules

- name: Configure Plymouth boot splash theme
  become: true
  lineinfile:
    path: /etc/plymouth/plymouthd.conf
    regexp: "^Theme="
    line: "Theme=spinner"
    create: yes
    mode: "0644"
    backup: yes

- name: Check if plymouth is already in mkinitcpio hooks
  become: true
  shell: grep "^HOOKS=" /etc/mkinitcpio.conf | grep -q plymouth
  register: plymouth_check
  failed_when: false
  changed_when: false

- name: Create timestamped backup of mkinitcpio.conf
  become: true
  copy:
    src: /etc/mkinitcpio.conf
    dest: "/etc/mkinitcpio.conf.bak.{{ ansible_facts.date_time.epoch }}"
    remote_src: yes
    mode: '0644'
  when: plymouth_check.rc != 0

- name: Check if system uses base udev or base systemd
  become: true
  shell: grep "^HOOKS=" /etc/mkinitcpio.conf
  register: hooks_line
  changed_when: false

- name: Add Plymouth to mkinitcpio hooks after base udev (preserving existing hooks)
  become: true
  replace:
    path: /etc/mkinitcpio.conf
    regexp: '^(HOOKS=\([^)]*base udev)(\s+)'
    replace: '\1 plymouth\2'
    backup: yes
  when:
    - plymouth_check.rc != 0
    - "'base udev' in hooks_line.stdout"
  notify: rebuild initramfs

- name: Add Plymouth to mkinitcpio hooks after base systemd (preserving existing hooks)
  become: true
  replace:
    path: /etc/mkinitcpio.conf
    regexp: '^(HOOKS=\([^)]*base systemd)(\s+)'
    replace: '\1 plymouth\2'
    backup: yes
  when:
    - plymouth_check.rc != 0
    - "'base systemd' in hooks_line.stdout"
  notify: rebuild initramfs

- name: Warn if neither base udev nor base systemd found
  debug:
    msg: "WARNING: Could not add Plymouth hook - neither 'base udev' nor 'base systemd' found in HOOKS"
  when:
    - plymouth_check.rc != 0
    - "'base udev' not in hooks_line.stdout"
    - "'base systemd' not in hooks_line.stdout"

# NVIDIA Wayland/Hyprland integration
- name: Deploy NVIDIA DRM modprobe config
  become: true
  copy:
    src: nvidia-drm.conf
    dest: /etc/modprobe.d/nvidia-drm.conf
    mode: "0644"
    backup: yes
  notify: rebuild initramfs
  when: gpu_vendor | default('') == 'nvidia'

- name: Ensure pacman hooks directory exists
  become: true
  file:
    path: /etc/pacman.d/hooks
    state: directory
    mode: "0755"
  when: gpu_vendor | default('') == 'nvidia'

- name: Deploy NVIDIA pacman hook for initramfs rebuild
  become: true
  copy:
    src: nvidia.hook
    dest: /etc/pacman.d/hooks/nvidia.hook
    mode: "0644"
  when: gpu_vendor | default('') == 'nvidia'

- name: Check if nvidia modules are in mkinitcpio MODULES
  become: true
  shell: grep "^MODULES=" /etc/mkinitcpio.conf | grep -q nvidia
  register: nvidia_modules_check
  failed_when: false
  changed_when: false
  when: gpu_vendor | default('') == 'nvidia'

- name: Add NVIDIA modules to mkinitcpio for early KMS
  become: true
  replace:
    path: /etc/mkinitcpio.conf
    regexp: '^MODULES=\(([^)]*)\)'
    replace: 'MODULES=(\1 nvidia nvidia_modeset nvidia_uvm nvidia_drm)'
    backup: yes
  notify: rebuild initramfs
  when:
    - gpu_vendor | default('') == 'nvidia'
    - nvidia_modules_check.rc != 0

# Fingerprint reader support
- name: Check for fingerprint reader hardware
  shell: lsusb | grep -qi "fingerprint\|goodix\|elan.*fingerprint\|synaptics.*fingerprint"
  register: fingerprint_check
  failed_when: false
  changed_when: false

- name: Enable fprintd service
  become: true
  systemd:
    name: fprintd
    enabled: yes
  when: fingerprint_check.rc == 0

# Hardware sensor monitoring
- name: Run sensors-detect to configure sensor modules
  become: true
  command: sensors-detect --auto
  register: sensors_detect
  changed_when: "'no sensors were detected' not in sensors_detect.stdout"
  failed_when: false

- name: Enable lm_sensors service
  become: true
  systemd:
    name: lm_sensors
    enabled: yes
    state: started

# Hyprland monitor configuration
- name: Create Hyprland config directory
  file:
    path: "{{ ansible_facts.env.HOME }}/.config/hypr"
    state: directory
    mode: "0755"

- name: Check if monitors.conf exists
  stat:
    path: "{{ ansible_facts.env.HOME }}/.config/hypr/monitors.conf"
  register: monitors_conf

- name: Create default monitors.conf (all monitors at preferred resolution)
  copy:
    content: |
      # Auto-generated default: all monitors at preferred resolution
      # Customize per-machine. Examples:
      #   monitor=eDP-1,preferred,auto,1           # laptop built-in
      #   monitor=DP-1,2560x1440@144,0x0,1         # external at 144Hz
      #   monitor=DP-2,1920x1080,2560x0,1           # second external, right of first
      # Docs: https://wiki.hyprland.org/Configuring/Monitors/
      monitor=,preferred,auto,1
    dest: "{{ ansible_facts.env.HOME }}/.config/hypr/monitors.conf"
    mode: "0644"
  when: not monitors_conf.stat.exists

# XDG Mime Type Configuration
- name: Ensure applications directory exists
  file:
    path: "{{ ansible_facts.env.HOME }}/.local/share/applications"
    state: directory
    mode: "0755"

- name: Update desktop database
  shell: update-desktop-database ~/.local/share/applications
  become: false
  changed_when: false
  failed_when: false

- name: Set default application for images (imv)
  shell: |
    xdg-mime default imv.desktop image/png
    xdg-mime default imv.desktop image/jpeg
    xdg-mime default imv.desktop image/gif
    xdg-mime default imv.desktop image/webp
    xdg-mime default imv.desktop image/bmp
    xdg-mime default imv.desktop image/tiff
  become: false
  changed_when: false

- name: Set default application for PDFs (evince)
  shell: xdg-mime default org.gnome.Evince.desktop application/pdf
  become: false
  changed_when: false

- name: Set default web browser
  shell: |
    xdg-mime default {{ default_browser_desktop | default('zen.desktop') }} x-scheme-handler/http
    xdg-mime default {{ default_browser_desktop | default('zen.desktop') }} x-scheme-handler/https
  become: false
  changed_when: false

- name: Set default application for videos (mpv)
  shell: |
    xdg-mime default mpv.desktop video/mp4
    xdg-mime default mpv.desktop video/x-msvideo
    xdg-mime default mpv.desktop video/x-matroska
    xdg-mime default mpv.desktop video/webm
    xdg-mime default mpv.desktop video/quicktime
  become: false
  changed_when: false

- name: Install desktop AUR packages
  kewlfft.aur.aur:
    name: "{{ item }}"
    use: paru
    state: present
    extra_args: --noconfirm --needed
  become: yes
  become_user: aur_builder
  vars:
    ansible_python_interpreter: /usr/bin/python3
  loop: "{{ aur_packages.desktop }}"
  register: aur_desktop_results
  when: aur_packages.desktop | length > 0

- name: Report failed desktop AUR packages
  fail:
    msg: |
      The following desktop AUR packages failed to install:
      {% for result in aur_desktop_results.results | selectattr('failed', 'defined') | selectattr('failed') %}
      - {{ result.item }}: {{ result.msg | default('unknown error') }}
      {% endfor %}
  when:
    - aur_desktop_results.results is defined
    - aur_desktop_results.results | selectattr('failed', 'defined') | selectattr('failed') | list | length > 0
