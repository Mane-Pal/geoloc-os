---
# Base role - Essential system setup
# This role installs core system packages and basic CLI tools

- name: Update pacman database
  become: true
  pacman:
    update_cache: yes

# Locale and timezone configuration
- name: Generate en_US.UTF-8 locale
  become: true
  locale_gen:
    name: en_US.UTF-8
    state: present

- name: Generate extra locale
  become: true
  locale_gen:
    name: "{{ extra_locale }}"
    state: present
  when: extra_locale is defined

- name: Set system locale
  become: true
  copy:
    content: |
      LANG=en_US.UTF-8
      {% if lc_time is defined %}
      LC_TIME={{ lc_time }}
      {% endif %}
    dest: /etc/locale.conf
    mode: '0644'

- name: Set timezone
  become: true
  timezone:
    name: "{{ timezone | default('Europe/Copenhagen') }}"

# Performance optimizations
- name: Configure pacman with optimizations
  become: true
  copy:
    src: pacman.conf
    dest: /etc/pacman.conf
    mode: '0644'
    backup: yes
  notify: refresh pacman cache

- name: Install base packages
  become: true
  pacman:
    name: "{{ packages.base + ([cpu_ucode] if cpu_ucode is defined else []) }}"
    state: present

- name: Create user local directories
  file:
    path: "{{ ansible_facts.env.HOME }}/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - .local/bin
    - .local/share
    - .config

- name: Set zsh as default shell
  become: true
  user:
    name: "{{ ansible_facts.env.USER }}"
    shell: /bin/zsh

- name: Disable systemd-networkd-wait-online (using NetworkManager instead)
  become: true
  systemd:
    name: systemd-networkd-wait-online.service
    enabled: no
    masked: yes

# System stability optimizations
- name: Disable USB autosuspend to prevent peripheral disconnection issues
  become: true
  lineinfile:
    path: /etc/modprobe.d/disable-usb-autosuspend.conf
    line: 'options usbcore autosuspend=-1'
    create: yes
    mode: '0644'
    backup: yes
  notify: rebuild initramfs

- name: Configure power button to ignore instead of shutdown
  become: true
  lineinfile:
    path: /etc/systemd/logind.conf
    regexp: '^#?HandlePowerKey='
    line: 'HandlePowerKey=ignore'
    backup: yes
  notify: restart systemd-logind

- name: Fix SSH connection flakiness with MTU probing
  become: true
  sysctl:
    name: net.ipv4.tcp_mtu_probing
    value: '1'
    sysctl_file: /etc/sysctl.d/99-ssh-fixes.conf
    reload: yes

# Quality of life improvements
- name: Configure sudo password attempts
  become: true
  copy:
    src: sudoers-passwd-tries
    dest: /etc/sudoers.d/passwd-tries
    mode: '0440'
    validate: 'visudo -cf %s'
    backup: yes

- name: Configure PAM faillock
  become: true
  copy:
    src: faillock.conf
    dest: /etc/security/faillock.conf
    mode: '0644'
    backup: yes

- name: Create GPG config directory
  become: true
  file:
    path: /etc/gnupg
    state: directory
    mode: '0755'

- name: Configure GPG keyservers
  become: true
  copy:
    src: dirmngr.conf
    dest: /etc/gnupg/dirmngr.conf
    mode: '0644'
    backup: yes

# System services
- name: Enable systemd-timesyncd (NTP time sync)
  become: true
  systemd:
    name: systemd-timesyncd
    enabled: yes
    state: started

- name: Enable fstrim timer for SSD TRIM
  become: true
  systemd:
    name: fstrim.timer
    enabled: yes
    state: started

# Journald log retention
- name: Create journald config directory
  become: true
  file:
    path: /etc/systemd/journald.conf.d
    state: directory
    mode: "0755"

- name: Configure journald log retention
  become: true
  copy:
    src: journald-retention.conf
    dest: /etc/systemd/journald.conf.d/retention.conf
    mode: "0644"
    backup: yes

# Reflector mirror optimization
- name: Configure reflector for fast pacman mirrors
  become: true
  template:
    src: reflector.conf.j2
    dest: /etc/xdg/reflector/reflector.conf
    mode: "0644"
    backup: yes

- name: Enable reflector timer for periodic mirror updates
  become: true
  systemd:
    name: reflector.timer
    enabled: yes
    state: started

# zram compressed swap
- name: Configure zram-generator for compressed swap
  become: true
  copy:
    src: zram-generator.conf
    dest: /etc/systemd/zram-generator.conf
    mode: "0644"
    backup: yes

# XDG user directories
- name: Create standard XDG user directories
  command: xdg-user-dirs-update
  become: false
  changed_when: false

# pkgfile command-not-found integration
- name: Update pkgfile database
  become: true
  command: pkgfile --update
  changed_when: false

- name: Enable pkgfile update timer
  become: true
  systemd:
    name: pkgfile-update.timer
    enabled: yes
    state: started

# AUR helper setup
- name: Verify paru is installed and functional
  command: paru --version
  become: false
  register: paru_check
  failed_when: false
  changed_when: false


# AUR builder user setup (per kewlfft.aur official docs)
- name: Create the aur_builder user
  user:
    name: aur_builder
    create_home: yes
    group: wheel
    shell: /usr/sbin/nologin
  become: true
  when: paru_check.rc == 0

- name: Allow aur_builder to run sudo pacman without password
  lineinfile:
    path: /etc/sudoers.d/11-install-aur_builder
    line: 'aur_builder ALL=(ALL) NOPASSWD: /usr/bin/pacman'
    create: yes
    mode: '0644'
    validate: 'visudo -cf %s'
  become: true
  when: paru_check.rc == 0


